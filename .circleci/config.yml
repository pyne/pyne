version: 2.1
commands:
  checkout_build:
    description: "Checkout PyNE, build with the provided flags"
    parameters:
      flags:
        type: string
        default: ""
    steps:
      - checkout
      - run: python setup.py install --user --clean << parameters.flags >> 

  run_test:
    description: "Run tests"
    parameters:
      flags:
        type: string
        default: ""
    steps:
      - run: |
          cd ~/repo/tests
          ./travis-run-tests.sh << parameters.flags >>




jobs:
  py3_build:
    docker:
      - image: pyne/pshriwise:ubuntu_17.04_pymoab_pyne
    working_directory: ~/repo
    steps:
      - checkout_build:
          flags: ""
      - run_test:
          flags: "python3"



  py2_build:
    docker:
      - image: pyne/ubuntu_18.04_pyne-deps:latest
    working_directory: ~/repo
    steps:
      - checkout_build:
          flags: ""
      - run_test:
          flags: "python2"



  py2_dagmc_build:
    docker:
      - image: pyne/ubuntu_18.04_dagmc_pyne-deps:latest
    working_directory: ~/repo
    steps:
      - checkout_build:
          flags: "--moab $HOME/opt/moab --dagmc $HOME/opt/dagmc"
      - run_test:
          flags: "python2"



  py2_pymoab_build:
    docker:
      - image: pyne/ubuntu_18.04_pymoab_pyne-deps:latest
    working_directory: ~/repo
    steps:
      - checkout_build:
          flags: "--moab $HOME/opt/moab"
      - run_test:
          flags: "python2"
  

  py2_dagmc_pymoab_build:
    docker:
      - image: pyne/ubuntu_18.04_dagmc_pymoab_pyne-deps:latest
    working_directory: ~/repo
    steps:
      - checkout_build:
          flags: "--moab $HOME/opt/moab --dagmc $HOME/opt/dagmc"
      - run_test:
          flags: "python2"

workflows:
  version: 2
  build_and_test:
    jobs:
      - py3_build
    
      - py2_build

      - py2_dagmc_build
      
      - py2_pymoab_build
      
      - py2_dagmc_pymoab_build
