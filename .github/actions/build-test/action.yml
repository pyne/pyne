name: BuildTest
description: Builds and tests an installation of PyNE in a single docker image.  This action is used for bootstrap testing when building the docker images as well as testing of each PR using those docker images.
inputs:
  stage:
    description: The docker stage that will be used as the docker image for testing.
    required: true
    default: ''
  hdf5:
    description: Information about which version of HDF5 will be used for testing.
    required: true
    default: ''
runs:
  using: "composite"
  steps: 
    - name: Setup Environment Variables
      shell: bash -l {0}
      run: |
        if [[ "${{ inputs.stage }}" == "moab" || "${{ inputs.stage }}" == "dagmc" ]]; then
          echo "MOAB_ROOT=/root/opt/moab" >> $GITHUB_ENV
        fi
        if [[ "${{ inputs.stage }}" == "dagmc" ]]; then
          echo "DAGMC_ROOT=/root/opt/dagmc" >> $GITHUB_ENV
        fi
        if [[ "${{ inputs.hdf5 }}" == "_hdf5" ]]; then
          echo "HDF5_ROOT=/root/opt/hdf5/hdf5-1_12_0" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=/root/opt/hdf5/hdf5-1_12_0:${LD_LIBRARY_PATH}" >> $GITHUB_ENV
        fi

    - name: Building PyNE
      shell: bash -l {0}
      run: |
        cd $GITHUB_WORKSPACE
        pip3 install . --user
        export PATH="$PATH:/github/home/.local/bin"

    - name: Testing PyNE
      shell: bash -l {0}
      run: |
        cd $GITHUB_WORKSPACE/tests
        nuc_data_make
        ./ci-run-tests.sh python3